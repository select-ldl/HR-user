(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{"./runtime-repl/collection/sidebar/CollectionSidebarController.js":function(e,t,o){"use strict";o.r(t),function(e){o.d(t,"default",(function(){return w}));var i,r,s=o("../../node_modules/mobx/lib/mobx.module.js"),a=o("./js/stores/get-store.js"),l=o("./js/modules/controllers/PermissionController.js"),n=o("./runtime-repl/extensible-collection/api/ExtensibleCollectionAPI.ts"),d=o.n(n),c=o("./runtime-repl/collection/sidebar/CollectionSidebarModel.js"),u=o("./runtime-repl/collection/datastores/adapters/CollectionModelEventsAdapter.js"),p=o("./runtime-repl/folder/datastores/adapters/FolderModelEventsAdapter.js"),m=o("./runtime-repl/request-http/datastores/adapters/RequestModelEventsAdapter.js"),h=o("./runtime-repl/example/datastores/adapters/ResponseModelEventsAdapter.js"),b=o("./runtime-repl/collection/datastores/adapters/CollectionListingAPIAdapter.js"),S=o("./runtime-repl/_common/WorkbenchStatusConstants.js"),C=o("./onboarding/src/common/dependencies.js"),g=o("./runtime-repl/_common/SyncEndpoints.js"),f=o("./runtime-repl/collection/_api/CollectionStoreV2.js"),y=o("./runtime-repl/collection/services/CollectionPerformanceMetricsService.ts"),A=o.n(y);function E(e,t,o,i,r){var s={};return Object.keys(i).forEach((function(e){s[e]=i[e]})),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=o.slice().reverse().reduce((function(o,i){return i(e,t,o)||o}),s),r&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(r):void 0,s.initializer=void 0),void 0===s.initializer&&(Object.defineProperty(e,t,s),s=null),s}let w=(r=E((i=class{constructor(){var e,t,o,i;this.model=null,this._adapters=[],e=this,t="status",i=this,(o=r)&&Object.defineProperty(e,t,{enumerable:o.enumerable,configurable:o.configurable,writable:o.writable,value:o.initializer?o.initializer.call(i):void 0})}async didCreate(){A.a.startTrace(y.CollectionPerformanceTraces.SIDEBAR),A.a.addMarker(y.CollectionPerformanceTraces.SIDEBAR,y.CollectionPerformanceMarkers.SIDEBAR_LOAD_START),this.model=new c.default;try{await this._loadFromListingAPI(),await this._loadExtensibleCollections(),this.setSidebarStatus(S.READY)}catch(e){pm.logger.error("CollectionSidebarController~didCreate: Failed to fetch collection list:",e)}A.a.addMarker(y.CollectionPerformanceTraces.SIDEBAR,y.CollectionPerformanceMarkers.SIDEBAR_LOAD_END),A.a.endTrace(y.CollectionPerformanceTraces.SIDEBAR),this.model.collectionList=await f.default.subscribe();const e=e=>e&&Object(a.getStore)("CollectionStore").find(Object(C.decomposeUID)(e).modelId);try{await Object(s.when)((()=>this.model.collectionList.ids.every(e)),{timeout:6e4})}catch(e){pm.logger.warn("CollectionSidebarController~didCreate: Timed out while waiting for store to be fully hydrated",e)}try{await this._loadFromModelEventsAdapter()}catch(e){return pm.logger.error("CollectionSidebarController~didCreate: Error in loading collections from model events",e),this.status===S.LOADING&&this.setSidebarStatus(S.ERROR)}return this.setSidebarStatus(S.READY)}beforeDestroy(){this._adapters&&this._adapters.forEach((t=>{e.isFunction(t.dispose)&&t.dispose()})),this.extensibleCollectionChangeListenersDisposer&&this.extensibleCollectionChangeListenersDisposer(),this.model=null,this._adapters=[]}setSidebarStatus(e){this.status=e}async _fetchCollections(){await Object(a.getStore)("SyncStatusStore").onSyncAvailable();const t=Object(a.getStore)("ActiveWorkspaceStore").id,o=await C.RemoteSyncRequestService.request(g.COLLECTION_LIST`${t}`,{method:"POST",timeout:3e4}),i=e.forEach(e.get(o,"body.data",[]),(t=>{const o={model:"collection",modelId:t.id,action:"UPDATE_COLLECTION"},i=l.default.getCompositeKey(o);!Object(a.getStore)("PermissionStore").members.has(i)&&e.set(t,"attributes.permissions.userCanUpdate",!0)}));return this.model.hydrate&&this.model.hydrate(i),i}async _loadExtensibleCollections(){let e;try{e=await d.a.list()}catch(e){pm.logger.error("CollectionSidebarController~_loadExtensibleCollections",e)}this.model.hydrateExtensibleCollection(e),this.extensibleCollectionChangeListenersDisposer=d.a.cacheAPI.subscribeToChanges(this.model.getExtensibleCollectionEventListeners())}async _loadFromListingAPI(){!function(t){if(e.isEmpty(t))return;const o=[],i=[],r=[],s=[];t.forEach((t=>{const a=e.get(t,"attributes.flags.isFavorite"),l=e.get(t,"attributes.permissions.teamCanView"),n=e.get(t,"attributes.permissions.anybodyCanView"),d=e.get(t,"attributes.flags.isArchived"),c=Object(C.decomposeUID)(t.id).modelId,u={id:c};a&&o.push(u),l&&i.push(u),n&&r.push({id:t.id}),d&&s.push({model:"collection",modelId:c})})),!e.isEmpty(o)&&Object(a.getStore)("FavoritedCollectionStore").add(o),!e.isEmpty(i)&&Object(a.getStore)("SharedCollectionsStore").add(i),!e.isEmpty(r)&&Object(a.getStore)("PublicEntityStore").add(r),!e.isEmpty(s)&&Object(a.getStore)("ArchivedResourceStore").add(s)}(await this._fetchCollections())}async _loadFromModelEventsAdapter(){const e=Object(a.getStore)("ActiveWorkspaceStore").id,t=new u.default(this.model.getCollectionAdapterModel(),{activeWorkspace:e,useUID:!0}),o=new p.default(this.model.getFolderAdapterModel()),i=new m.default(this.model.getRequestAdapterModel()),r=[t.hydrate(),o.hydrate(),i.hydrate()];this._adapters.push(t,o,i),await Promise.all(r),this.setSidebarStatus(S.READY);const s=new h.default(this.model.getResponseAdapterModel());this._adapters.push(s),await s.hydrate()}async _loadFromListingAPIAdapter(){const e=new b.default(this.model.getCollectionAdapterModel());this._adapters.push(e),await e.hydrate()}}).prototype,"status",[s.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return S.LOADING}}),E(i.prototype,"setSidebarStatus",[s.action],Object.getOwnPropertyDescriptor(i.prototype,"setSidebarStatus"),i.prototype),i)}.call(this,o("./node_modules/lodash/lodash.js"))}}]);