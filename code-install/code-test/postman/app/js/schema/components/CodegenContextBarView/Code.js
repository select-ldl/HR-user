(window.webpackJsonp=window.webpackJsonp||[]).push([[59],{"./integrations/services/CodegenService.js":function(e,t,a){"use strict";a.r(t),function(e){var n=a("./js/modules/services/RemoteSyncRequestService.js"),o=a("./js/stores/get-store.js");async function r(e,t,a){return n.default.request("/ws/proxy",{method:"post",data:{service:"codegen",method:t,body:a,path:e}})}t.default={getTemplates:async function(){await Object(o.getStore)("SyncStatusStore").onSyncAvailable({timeout:8e3});const t=await r("/artifacts/server-code/options","get");return e.get(t,"body.templates")},generate:async function(t,a,n,o,s,i=""){const l={apiName:t,tagId:i,schemaId:a,language:n,variant:o,options:[{id:"contract",value:s}]};try{const t=await r("/artifacts/server-code","post",l),a=e.get(t,"body.data.downloadLink");return{url:a,filename:e.get(t,"body.data.filename")}}catch(e){if(e.error)throw e.error;throw e}}}}.call(this,a("./node_modules/lodash/lodash.js"))},"./schema/components/CodegenContextBarView/Code.js":function(e,t,a){"use strict";a.r(t),a.d(t,"default",(function(){return S}));var n,o=a("../../node_modules/react/index.js"),r=a.n(o),s=a("../../node_modules/mobx-react/dist/mobx-react.module.js"),i=a("./js/modules/services/AnalyticsService.js"),l=a("./integrations/services/CodegenService.js"),d=a("./js/services/NavigationService.js"),c=a("./schema/services/SchemaService.js"),g=a("./js/components/base/Buttons.js"),p=a("./appsdk/components/link/Link.js"),m=a("../../node_modules/@postman/aether/esmLib/index.js"),h=a("./js/components/base/Dropdowns.js"),u=a("./js/models/services/filesystem.js"),v=a("./schema/constants/SchemaEditorConstants.js"),f=a("./appsdk/contextbar/ContextBarViewHeader.js"),b=a("./js/components/base/LoadingIndicator.js"),y=a("./node_modules/lodash/lodash.js"),w=a.n(y),_=a("./js/stores/get-store.js");let S=Object(s.observer)(n=class extends o.Component{constructor(e){super(e),this.handleToggleContract=e=>{const{languageSelection:t}=this.state;let a=t.length?t.split("-")[0]:"",n=t.length?t.split("-").slice(1).join("-"):"",o=w.a.get(this.props,"contextData.editor")?"editor":"release";this.setState({contractOnly:e},(()=>{this.state.contractOnly&&i.default.addEventV2({category:"server_code",action:"options",label:`${o}_${a}_${n}_contract_only`,value:1})}))},this.triggerGenerateCode=async()=>{const{languageSelection:e,contractOnly:t,isRelease:a}=this.state,{apiName:n,schemaId:o,tagId:s}=this.getSchemaProperties(this.props.contextData);let d=e.split("-")[0],c=e.split("-").slice(1).join("-"),g=w.a.get(this.props,"contextData.editor")?"editor":"release",p=Object(_.getStore)("CurrentUserStore").isLoggedIn;if(i.default.addEventV2({category:"server_code",action:"generate",label:`${g}_${d}_${c}`,value:1}),!p)return pm.mediator.trigger("showSignInModal",{type:"generateServerCode",origin:"server_code_generate_code_button",continueUrl:new URL(window.location.href)});this.setState({zipUrl:null,filename:null,generating:!0});try{const{url:e,filename:a}=await l.default.generate(n,o,d,c,t,s);this.downloadGeneratedCode(e,a)}catch(e){let t="无法生成服务器样板. 稍后再试.";e.code&&"parseError"===e.code&&(t=r.a.createElement("span",null,"无法解析 OpenAPI 规范. 查看错误和警告在你的",a?"架构定义.":r.a.createElement("span",{className:"codegen__error-link",onClick:this.navigateToDefineTab},"架构定义."))),this.setState({zipUrl:null,filename:null,generating:!1,showError:!0,errMsg:t}),pm.logger.error(`Codegen~triggerGenerateCode - Error while waiting on response from generating code for ${n} - ${o}: `,e)}},this.downloadGeneratedCode=(e,t)=>{e?fetch(e).then((e=>{e.arrayBuffer().then((e=>{Object(u.saveAndOpenFile)(t,new Uint8Array(e),"application/zip",((e,t)=>{e?(pm.logger.error("Codegen~downloadGeneratedCode - Failed to download generated code.",e),pm.toasts.error("无法下载生成的代码"),this.setState({generating:!1})):(this.setState({generating:!1,showError:!1}),t===u.STATE.SUCCESS&&"browser"!==window.SDK_PLATFORM&&pm.toasts.success("服务器样板已成功下载",{title:"代码已生成"}))}))}))})).catch((e=>{pm.logger.error("Codegen~downloadGeneratedCode - Failed to download generated code.",e),pm.toasts.error("无法下载生成的代码"),this.setState({generating:!1})})):(this.setState({generating:!1,showError:!0,errMsg:"出了些问题. 请再试一次."}),pm.logger.error("Codegen~downloadGeneratedCode - Invalid url given for download",e))},this.renderLanguageMenuItems=e=>{let{templates:t,languageSelection:a}=this.state,n="选择",o=[];if(w.a.isArray(t))for(let e of t)if(w.a.isArray(e.variants))for(let t of e.variants){let s=e.key+"-"+t.key;s===a&&(n=e.label+" - "+t.label),o.push(r.a.createElement(h.MenuItem,{key:s,refKey:s},r.a.createElement("div",{className:"codegen__dropdown-menu-item-label"},e.label," - ",t.label)))}return r.a.createElement(h.Dropdown,{className:"codegen__modal-dropdown",onSelect:this.handleDropdownActionSelect,keyMapHandlers:{quit:this.handleEscape}},r.a.createElement(h.DropdownButton,{type:"secondary",size:"small"},r.a.createElement(g.Button,{disabled:!e||0===o.length},r.a.createElement("div",{className:"codegen__selected-label"},n))),r.a.createElement(h.DropdownMenu,{"align-right":!0,className:"codegen__dropdown-menu"},o))},this.state={showError:!1,zipUrl:"",filename:"",errMsg:"",fetchingTemplates:!0,templates:null,apiType:null,isRelease:!1,contractOnly:!1,languageSelection:0,generating:!1,generateDisabled:!0},this.triggerGenerateCode=this.triggerGenerateCode.bind(this),this.downloadGeneratedCode=this.downloadGeneratedCode.bind(this),this.renderCodeSection=this.renderCodeSection.bind(this),this.handleDropdownActionSelect=this.handleDropdownActionSelect.bind(this),this.handleEscape=this.handleEscape.bind(this),this.handleToggleContract=this.handleToggleContract.bind(this),this.navigateToDefineTab=this.navigateToDefineTab.bind(this)}componentDidMount(){if((async()=>{try{const e=await l.default.getTemplates();this.setState({templates:e,fetchingTemplates:!1})}catch(e){this.setState({templates:null,showError:!0,fetchingTemplates:!1,errMsg:"无法获取可用语言和框架的列表."}),pm.logger.error("Codegen~templates - Error while waiting on response from getting templates: ",e)}})(),w.a.get(this.props,"contextData.editor")){const e=this.getApiType();i.default.addEventV2({category:"server_code",action:"open",label:"editor_"+e,value:1})}else this.setState({isRelease:!0}),this.fetchSchemaType()}getSchemaProperties(e){return w.a.get(e.model,"activeRelease")?{apiId:w.a.get(e.model,"api.id"),apiName:w.a.get(e.model,"api.name"),versionId:w.a.get(e.model,"apiVersion.id"),schemaId:w.a.get(e.model,"activeRelease.entities.schemas.0.entityId"),tagId:w.a.get(e.model,"activeRelease.entities.schemas.0.tag")}:{apiId:w.a.get(e,"model.apiId"),apiName:w.a.get(e,"model.apiName"),versionId:w.a.get(e,"model.id"),schemaId:w.a.get(e,"model.schema.schemaId"),tagId:null}}async fetchSchemaType(){const{schemaId:e,tagId:t}=this.getSchemaProperties(this.props.contextData);try{const a=await c.default.getReleaseSchema(e,t,["type"]);this.setState({apiType:w.a.get(a,"type",null)}),i.default.addEventV2({category:"server_code",action:"open",label:"release_"+w.a.get(a,"type",null),value:1})}catch(e){pm.logger.error("Codegen~fetchSchemaType - Error while fetching schema type for Release: ",e),this.setState({apiType:"Unknown"})}}getApiType(){return w.a.get(this.props,"contextData.editor")?w.a.get(this.props,"contextData.editor.activeType"):this.state.apiType}navigateToDefineTab(){const{apiId:e,versionId:t}=this.getSchemaProperties(this.props.contextData);d.default.transitionTo("build.apiVersion",{apiId:e,versionId:t},{tab:"define"},{replace:!0})}handleDropdownActionSelect(e){this.setState({languageSelection:e,generateDisabled:!1,showError:!1})}handleEscape(){this.props.onEscape&&this.props.onEscape()}renderCodeSection(){const{generating:e,generateDisabled:t,contractOnly:a,isRelease:n,fetchingTemplates:o}=this.state,s=this.getApiType();if(!s||o)return r.a.createElement("div",{className:"codegen__loader"},r.a.createElement(b.default,null));const l="openapi3"===s,d=e?"生成中...":"生成代码",c=!!n||w.a.get(this.props,"contextData.schemaValid"),h=!!n||!w.a.get(this.props,"contextData.editor.isDirty"),u=!!n||!!w.a.get(this.props,"contextData.editor.schema"),f=w.a.get(this.props,"contextData.model.apiPermissionStore").canGenerateCode,y=f?u?h?c?"":"添加有效架构以从中生成代码":"在生成代码之前保存您的更改.":"添加架构以从中生成代码":"您没有执行此操作的权限";return r.a.createElement("div",{className:"codegen__container"},!l&&r.a.createElement("div",{className:"codegen__banner"},r.a.createElement(m.Banner,null,"服务器样板生成仅支持 OpenAPI 3.0 格式.",s?`此 API 使用 ${v.SCHEMA_FORMAT_MAP[s]}.`:"")),r.a.createElement("div",{className:l?"":"codegen__disabled"},r.a.createElement("div",{className:"codegen__description"},r.a.createElement("span",null,"从您的 API 架构生成服务器样板. "),r.a.createElement(p.default,{to:"https://go.pstmn.io/docs-server-boilerplate-api",target:"_blank",onClick:()=>{i.default.addEventV2({category:"server_code",action:"learn_more",label:"docs",value:1})}},r.a.createElement("span",{className:"codegen__learn-more-link"},"了解更多"))),r.a.createElement("div",{className:"codegen__generate-text"},"语言和框架"),r.a.createElement("div",null,this.renderLanguageMenuItems(l)),r.a.createElement("div",{className:"codegen__options-container"},r.a.createElement(m.Checkbox,{isChecked:a,onChange:this.handleToggleContract,isDisabled:!l}),r.a.createElement("span",{className:"codegen__options-text"},"只生成路由和接口. "),r.a.createElement(p.default,{to:"https://go.pstmn.io/docs-server-boilerplate-api-contract-only",target:"_blank",onClick:()=>{i.default.addEventV2({category:"server_code",action:"learn_more",label:"docs_contract_only",value:1})}},r.a.createElement("span",{className:"codegen__learn-more-link"},"了解更多"))),r.a.createElement("div",{className:"codegen__button-container"},r.a.createElement(g.Button,{className:"codegen__generate-button",disabled:e||t||!l||!h||!c||!u||!f,type:"secondary",tooltip:y,onClick:this.triggerGenerateCode}," ",d," ")),this.state.showError&&r.a.createElement("div",{className:"codegen__banner"},r.a.createElement(m.Banner,{status:"error",onDismiss:()=>this.setState({showError:!1})},this.state.errMsg))))}render(){return r.a.createElement(o.Fragment,null,r.a.createElement(f.ContextBarViewHeader,{title:r.a.createElement("span",null,"代码生成",r.a.createElement(m.Badge,{status:"info",text:"测试"})),onClose:this.props.onClose}),this.renderCodeSection())}})||n}}]);