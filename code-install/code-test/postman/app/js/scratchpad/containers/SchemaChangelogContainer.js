(window.webpackJsonp=window.webpackJsonp||[]).push([[83],{34515:function(e,t,a){"use strict";a.r(t),a.d(t,"default",(function(){return y}));var s,o=a(2),n=a.n(o),r=a(2353),i=a(2753),c=a.n(i),h=a(5929),l=a(1656),g=a(2825),d=a.n(g),m=a(9),p=a(11405),u=a(11394),f=a(34516),S=a(11310),E=a(2778),_=a(7124),R=a(7326);let y=Object(r.observer)(s=class extends o.Component{constructor(e){super(e),this.state={revisions:[],loading:!0,error:!1,isRestoring:!1,restoreEntity:null,changelogsCursor:null,fetchingMoreLogs:!1,noSchema:!1,isOffline:!1},this.handleRestoreSchema=this.handleRestoreSchema.bind(this),this.handleRefresh=this.handleRefresh.bind(this),this.handleRetry=this.handleRetry.bind(this),this.handleFetchChangelog=this.handleFetchChangelog.bind(this),this.handleFetchMoreChangelog=this.handleFetchMoreChangelog.bind(this),this.getRefreshIconText=this.getRefreshIconText.bind(this)}componentDidMount(){this.disposeChangelogReaction=Object(l.reaction)((()=>c.a.get(this.props,"contextData.id")&&c.a.get(this.props,"contextData.versionId")&&!c.a.get(this.props,"contextData.schemaLoading")&&c.a.get(this.props,"contextData.schemaId")&&Object(h.getStore)("SyncStatusStore").isSocketConnected),(e=>{Object(h.getStore)("SyncStatusStore").isSocketConnected||!this.state.loading&&!this.state.error?(c.a.get(this.props,"contextData.schemaId")||this.setState({loading:!1,noSchema:!0,isOffline:!1}),e&&(this.setState({loading:!0,noSchema:!1,error:!1,isOffline:!1}),this.handleFetchChangelog(),E.default.addEventV2({category:"schema",action:"view_changelog",entityId:c.a.get(this.props,"contextData.schemaId")}))):this.setState({loading:!1,isOffline:!0})}),{fireImmediately:!0})}componentWillUnmount(){c.a.isFunction(this.disposeChangelogReaction)&&this.disposeChangelogReaction(),c.a.isFunction(this.disposeSocketReaction)&&this.disposeSocketReaction()}handleFetchChangelog(){const e=c.a.get(this.props,"contextData",{}).schemaId;e?Object(p.fetchChangelog)(e).then((e=>{this.setState({revisions:c.a.get(e,"data"),loading:!1,changelogsCursor:c.a.get(e,"meta.cursor.next")})})).catch((e=>{this.setState({loading:!1,error:!0}),pm.toasts.error(c.a.get(e,"message")||u.ERROR_FETCHING_CHANGELOG)})):pm.toasts.error(u.ERROR_FETCHING_CHANGELOG)}handleFetchMoreChangelog(){const e=this.state.changelogsCursor,t=c.a.get(this.props,"contextData",{}).schemaId;this.setState({fetchingMoreLogs:!0},(()=>{c.a.invoke(this.refs,"changelog.scrollMoreLoaderIntoView")})),Object(p.fetchChangelog)(t,e).then((e=>{this.setState({revisions:[...this.state.revisions,...c.a.get(e,"data")],fetchingMoreLogs:!1,changelogsCursor:c.a.get(e,"meta.cursor.next")})})).catch((e=>{this.setState({fetchingMoreLogs:!1,error:!0}),pm.toasts.error(c.a.get(e,"message")||u.ERROR_FETCHING_CHANGELOG)}))}handleRefresh(){this.setState({loading:!0,error:!1}),this.handleFetchChangelog()}handleRestoreSchema(e=null){if(!Object(h.getStore)("CurrentUserStore").isLoggedIn)return pm.mediator.trigger("showSignInModal",{type:"schema",subtitle:u.NOT_SIGNED_IN_ERROR,origin:"schema_changelog_restore"});if(!Object(h.getStore)("ActiveWorkspaceStore").isMember)return pm.mediator.trigger("openUnjoinedWorkspaceModal");if(E.default.addEventV2({category:"schema",action:"initiate_restore",entityId:c.a.get(this.props,"contextData.schemaId")}),this.setState({isRestoring:!0,restoreEntity:e}),e){const t=c.a.get(this.props,"contextData",{}).schemaId;Object(p.restoreSchema)(t,e).then((()=>{E.default.addEventV2({category:"schema",action:"successful_restore",entityId:t}),this.setState({isRestoring:!1},(()=>{this.handleRefresh()})),pm.toasts.success("You restored the schema successfully.")})).catch((e=>{this.setState({isRestoring:!1,restoreEntity:null}),E.default.addEventV2({category:"schema",action:"fail_restore",entityId:t}),pm.toasts.error(c.a.get(e,"message")||u.SCHEMA_RESTORE_FAILED)}))}}handleExpand(e,t){const a={diff:e,apiName:t};E.default.addEventV2({category:"schema",action:"expand_changelog",entityId:c.a.get(this.props,"contextData.schemaId")}),pm.mediator.trigger("showSchemaChangelogModal",a)}handleRetry(){this.setState({loading:!0,error:!1}),this.handleFetchChangelog()}getRefreshTextClass(){return d()({"schema-changelog-container__refresh-button":!0,"schema-changelog-container__refresh-button__loading":this.state.loading})}getRefreshIconText(){return Object(h.getStore)("SyncStatusStore").isSocketConnected?this.state.loading||this.state.fetchingMoreLogs||c.a.get(this.props,"contextData.schemaLoading")?"Please wait...":this.state.noSchema?"No schema found":"Fetch newer changelogs":u.OFFLINE_ERROR}render(){const e=c.a.get(this.props,"contextData.id"),t=c.a.get(this.props,"contextData.permissions"),a=S.default.hasPermission(t,"updateSchema","api",e);return n.a.createElement(o.Fragment,null,n.a.createElement(R.ContextBarViewHeader,{title:this.props.title,onClose:this.props.onClose},n.a.createElement(_.Button,{className:this.getRefreshTextClass(),tooltip:this.getRefreshIconText(),tooltipImmediate:!0,type:"tertiary",onClick:this.handleRefresh,disabled:this.state.loading||this.state.fetchingMoreLogs||this.state.noSchema||!Object(h.getStore)("SyncStatusStore").isSocketConnected},n.a.createElement(m.Icon,{name:"icon-action-refresh-stroke"}))),n.a.createElement("div",{className:"schema-changelog-container__content"},n.a.createElement(f.default,{ref:"changelog",apiName:c.a.get(this.props,"contextData.name"),changelogsExhausted:!this.state.changelogsCursor,error:this.state.error,fetchingMoreLogs:this.state.fetchingMoreLogs,isRestoring:this.state.isRestoring,isOffline:this.state.isOffline,loading:this.state.loading,noSchema:this.state.noSchema,restoreEntity:this.state.restoreEntity,revisions:this.state.revisions,schemaLoading:c.a.get(this.props,"contextData.schemaLoading"),updateSchemaPermission:a,onExpand:this.handleExpand,onRetry:this.handleRetry,onRestoreSchema:this.handleRestoreSchema,onFetchMoreChangelog:this.handleFetchMoreChangelog})))}})||s},34516:function(e,t,a){"use strict";a.r(t),function(e){a.d(t,"default",(function(){return C}));var s,o=a(2),n=a.n(o),r=a(2353),i=a(7113),c=a.n(i),h=a(8767),l=a(5929),g=a(29771),d=a(29772),m=a(29773),p=a(29774),u=a(7121),f=a(24590),S=a(29775),E=a(29777),_=a(7124),R=a(11394),y=a(29778);let C=Object(r.observer)(s=class extends o.Component{constructor(t){super(t),this.handleScroll=this.handleScroll.bind(this),this.handleScrollDebounced=e.debounce(this.handleScroll,100),this.scrollMoreLoaderIntoView=this.scrollMoreLoaderIntoView.bind(this),this.getRestoreTooltip=this.getRestoreTooltip.bind(this)}getDiffs(e){let t=e.diff.line.split("\n"),a=[],s=[];return t.forEach(((e,a)=>{e.includes("No newline at end of file")&&t.splice(a,1)})),t.forEach(((e,t)=>{"@"===e.charAt(0)&&s.push(t)})),s.forEach(((e,o)=>{o===s.length?a.push(t.slice(e,t.length)):a.push(t.slice(e,s[o+1]))})),a}getActorName(t){return"integration"===e.get(t,"createdBy.type")?n.a.createElement("div",{className:"changelog__header__action-description__actor-name"},"Integration"):e.get(t,"createdBy.isAccessible")?n.a.createElement(f.User,{id:e.get(t,"createdBy.id"),name:e.get(t,"createdBy.name")||e.get(t,"createdBy.username")}):n.a.createElement("div",{className:"changelog__header__action-description__actor-name"},e.get(t,"createdBy.name"))}getActorIcon(t){return"integration"===e.get(t,"createdBy.type")?n.a.createElement("div",{className:"changelog__actor-icon"},n.a.createElement(y.default,{className:"changelog__actor-icon__content"})):e.get(t,"createdBy.isAccessible")?n.a.createElement(f.ProfilePic,{id:e.get(t,"createdBy.id")}):n.a.createElement("div",{className:"changelog__actor-icon"},n.a.createElement(h.default,{size:"medium",userId:e.get(t,"createdBy.id"),customPic:e.get(t,"createdBy.profilePicUrl")}))}getActionText(e){return"create"===e?" created a new schema.":"update"===e?" made the following changes:":"restore"===e?" restored an older revision of the schema.":void 0}handleScroll(){const e=this.refs.contentRef;!this.props.changelogsExhausted&&!this.props.fetchingMoreLogs&&Object(l.getStore)("SyncStatusStore").isSocketConnected&&e&&e.scrollHeight-(e.scrollTop+e.offsetHeight)<=5&&this.props.onFetchMoreChangelog()}scrollMoreLoaderIntoView(){const e=this.refs.moreLoader;e&&e.scrollIntoView()}getRestoreTooltip(){return Object(l.getStore)("SyncStatusStore").isSocketConnected?this.props.updateSchemaPermission?"":R.PERMISSION_ERROR:R.OFFLINE_ERROR}render(){const t=!Object(l.getStore)("GateKeeperStore").isSyncEnabled||this.props.error;return this.props.loading||this.props.schemaLoading?n.a.createElement("div",{className:"changelog_loader"},n.a.createElement(u.default,null)):this.props.isOffline?n.a.createElement(g.default,null):t?n.a.createElement(d.default,{onRetry:this.props.onRetry}):this.props.noSchema?n.a.createElement(p.default,null):0===e.get(this.props,"revisions.length",0)&&this.props.changelogsExhausted?n.a.createElement(m.default,null):n.a.createElement("div",{className:"changelog__wrapper",ref:"contentRef",onScroll:this.handleScrollDebounced},(this.props.revisions||[]).map(((t,a)=>{let s=this.getDiffs(t),o=c.a.getFormattedDateAndTime(t.createdAt);return n.a.createElement("div",{key:a,className:"changelog"},n.a.createElement(f.Header,null,this.getActorIcon(t),n.a.createElement("div",{className:"changelog__header"},n.a.createElement("div",{className:"changelog__header__date"},o),n.a.createElement("div",{className:"changelog__header__action-description"},this.getActorName(t),n.a.createElement("span",null,this.getActionText(t.action))))),e.map(s,((e,t)=>{let a;return a=e.length>11?e.slice(0,11):e,n.a.createElement("div",{className:"changelog-content-container",key:t},n.a.createElement("div",{className:"changelog-content-container__content",onClick:()=>{this.props.onExpand(e,this.props.apiName)}},n.a.createElement(S.default,{diff:a}),n.a.createElement(E.default,{diff:a}),n.a.createElement("div",{className:"changelog-content-container__content__shadow"})))})),e.has(t,"allowedActions.restore")&&t.allowedActions.restore&&n.a.createElement("div",{className:"changelog-restore"},this.props.isRestoring&&this.props.restoreEntity===t.id?n.a.createElement("div",{className:"changelog-restore__loading"},n.a.createElement(u.default,null)):n.a.createElement(_.Button,{className:"changelog-restore__button",type:"text",onClick:()=>{this.props.onRestoreSchema(t.id)},disabled:!this.props.updateSchemaPermission||!Object(l.getStore)("SyncStatusStore").isSocketConnected,tooltip:this.getRestoreTooltip(),tooltipImmediate:!0},"Restore")))})),!this.props.changelogsExhausted&&this.props.fetchingMoreLogs&&n.a.createElement("div",{ref:"moreLoader",className:"changelog__more-loader"},n.a.createElement(u.default,null)))}})||s}.call(this,a(2753))}}]);