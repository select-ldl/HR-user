(window.webpackJsonp=window.webpackJsonp||[]).push([[66],{24826:function(e,t,s){"use strict";s.r(t),function(e){s.d(t,"EmptyState",(function(){return S})),s.d(t,"default",(function(){return O}));var n,i=s(2),o=s.n(i),a=s(9),r=s(2353),l=s(1656),m=s(7126),c=s.n(m),h=(s(47),s(6912)),d=s(10903),p=s(10144),u=s(5929),g=s(7326),y=s(7121),C=s(7124),E=s(7327),b=s(10160);function f(){return f=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&(e[n]=s[n])}return e},f.apply(this,arguments)}function S(e){return o.a.createElement("div",{className:"pull-request-container__empty-state"},o.a.createElement("div",{className:"sidebar-empty-state__icon-container"},o.a.createElement(a.Icon,{className:"sidebar-empty-state__icon",size:"large",color:"content-color-tertiary",name:e.icon})),o.a.createElement("div",{className:"sidebar-empty-state__title"},o.a.createElement("h4",null,e.title)),o.a.createElement("div",{className:"sidebar-empty-state__body"},o.a.createElement(E.default,{type:"body-medium",value:e.message})))}let O=Object(r.observer)(n=c()(n=class extends i.Component{constructor(t){super(t),this.state={input:"",open:t.open,creating:!1,updating:[],deleting:[],loadError:null,deleteError:null,updateError:null,creatorDetails:null,loading:this.props.loadingComments,comments:{},hasError:!1,showEntityComments:!1,showPullRequestComments:e.get(this.props,"contextData.showComments"),modelId:e.get(this.props,"contextData.modelId")||this.props.modelId,model:e.get(this.props,"contextData.model")||this.props.model,anchor:this.props.anchor},this.handleFocus=this.handleFocus.bind(this),this.handleFetch=this.handleFetch.bind(this),this.handleUpdate=this.handleUpdate.bind(this),this.handleCreate=this.handleCreate.bind(this),this.handleRetry=this.handleRetry.bind(this),this.handleDelete=this.handleDelete.bind(this),this.setListRef=this.setListRef.bind(this),this.parseError=this.parseError.bind(this),this.parseTags=this.parseTags.bind(this),this.isOnline=this.isOnline.bind(this),this.initiate=this.initiate.bind(this),this.handleClickOutside=this.handleClickOutside.bind(this),this.handleHideComments=this.handleHideComments.bind(this),this.toggleEntityComments=this.toggleEntityComments.bind(this),this.processComments=this.processComments.bind(this)}componentDidMount(){this.props.entityComments?this.processComments(this.props.comments):this.initiate()}initiate(){this.fetchCommentDisposer=Object(l.reaction)((()=>Object(u.getStore)("SyncStatusStore").isSocketConnected),(e=>{e&&this.handleFetch()}),{fireImmediately:!0})}componentWillUnmount(){this.fetchCommentDisposer&&this.fetchCommentDisposer()}UNSAFE_componentWillReceiveProps(t){(!this.props.loading&&t.loading||this.props.loading&&!t.loading)&&this.setState({loading:t.loading}),(e.get(this.props,"comments.comments")||[]).length>0&&this.processComments(this.props.comments)}handleClickOutside(){this.handleHideComments()}toggleEntityComments(){this.setState((e=>({showEntityComments:!e.showEntityComments})))}handleHideComments(){this.state.showEntityComments&&this.setState({showEntityComments:!1})}scrollToEnd(){if(!this.listRef)return;const e=this.listRef.scrollHeight-this.listRef.clientHeight;this.listRef.scrollTop=e>0?e:0}handleFocus(){this.props.focusRightOverlay&&this.props.focusRightOverlay()}parseTags(t,s){return t?Object.keys(t).reduce(((n,i)=>(n[i]=f({},t[i]||{},{id:`${e.get(t,[i,"id"])}`,userDetails:e.get(s,e.get(t,[i,"id"]))}),n)),{}):null}parseError(e){return e?e.message:""}isOnline(){return Object(u.getStore)("SyncStatusStore").isSocketConnected}setListRef(e){this.listRef=e}handleUpdate(t){if(this.isOnline())return this.setState((s=>({updating:e.union(s.updating,[t.id])}))),d.default.updateComment(t.id,t.body,t.tags).then((s=>{this.setState((n=>({hasError:!1,updating:e.remove(n.updating,t.id),comments:f({},this.state.comments||{},{[e.get(s,"comment.id")]:f({},this.state.comments[e.get(s,"comment.id")],{body:e.get(s,"comment.body"),tags:this.parseTags(e.get(s,"comment.tags")),updatedAt:e.get(s,"comment.updatedAt")})})}))),this.handleFocus()})).catch((s=>{pm.toasts.error(this.parseError(s)||"An error occurred while updating the comment.",{title:"Unable to save comment"}),this.setState((n=>({hasError:!0,updating:e.remove(n.updating,t.id),updatingError:this.parseError(s)}))),this.handleFocus()}));pm.toasts.error("You need to be online to update comment.")}handleCreate(t,s){this.isOnline()?(this.setState({creating:!0}),d.default.createComment(this.state.model,this.state.modelId,t,s,this.state.anchor||e.get(this.props,"contextData.anchor")).then((t=>{this.setState({hasError:!1,creating:!1,comments:f({},this.state.comments||{},{[e.get(t,"comment.id")]:{body:e.get(t,"comment.body"),tags:this.parseTags(e.get(t,"comment.tags")),id:e.get(t,"comment.id"),updatedAt:e.get(t,"comment.updatedAt"),createdAt:e.get(t,"comment.createdAt"),createdBy:e.get(t,"comment.createdBy"),creatorDetails:{friendly:Object(u.getStore)("CurrentUserStore").name||Object(u.getStore)("CurrentUserStore").username||Object(u.getStore)("CurrentUserStore").email,id:Object(u.getStore)("CurrentUserStore").id,profilePicUrl:Object(u.getStore)("CurrentUserStore").profile_pic_url}}})},this.scrollToEnd)})).catch((e=>{this.setState({creating:!1,hasError:!0}),pm.toasts.error(this.parseError(e)||"An error occurred while creating a comment.",{title:"Unable to save comment"})}))):pm.toasts.error("You need to be online to comment.")}handleDelete(t){if(this.isOnline())return this.setState((s=>({deleting:e.union(s.deleting,[t])}))),d.default.deleteComment(t).then((()=>{this.setState((s=>({deleting:e.remove(s.deleting,t),comments:e.omit(this.state.comments,[t])}))),this.handleFocus()})).catch((s=>{this.setState((n=>({deleting:e.remove(n.deleting,t),deletingError:this.parseError(s)}))),pm.toasts.error(this.parseError(s)||"An error occurred while deleting the comment."),this.handleFocus()}));pm.toasts.error("You need to be online to delete comment.")}processComments(t,s){const n=(t.comments||[]).filter((t=>t.anchor===this.state.anchor||e.get(this.props,"contextData.anchor")));this.setState(f({comments:n&&n.reduce(((e,s)=>(t.createdBy&&t.createdBy[s.createdBy]&&(e[s.id]=Object.assign(s,{tags:this.parseTags(s.tags,t.users),creatorDetails:f({},t.createdBy[s.createdBy],{friendly:t.createdBy[s.createdBy].friendly||t.createdBy[s.createdBy].username||t.createdBy[s.createdBy].email,id:`${t.createdBy[s.createdBy].id}`,profilePicUrl:t.createdBy[s.createdBy].profilePicUrl})})),e)),{}),updating:n,deleting:n},s),this.scrollToEnd),this.handleFocus()}handleFetch(){const{showEntityComments:t}=this.state;this.setState({loading:!0,loadError:null,showEntityComments:!1}),d.default.getComments(this.state.model,this.state.modelId,this.state.anchor||e.get(this.props,"contextData.anchor")).then((e=>{this.processComments(e,{loading:!1,showEntityComments:t})})).catch((e=>{this.setState({loading:!1,loadError:this.parseError(e),showEntityComments:t}),this.handleFocus()}))}handleRetry(){Object(u.getStore)("SyncStatusStore").isSocketConnected?this.handleFetch():pm.toasts.error("You can perform this action once you're back online",{title:"You are offline"})}render(){const t=Object(u.getStore)("CurrentUserStore"),s=Object(u.getStore)("TeamUserStore"),n={name:t.name,isLoggedIn:t.isLoggedIn,userName:t.username_email,id:t.id,organizations:t.organizations,teamSyncEnabled:t.teamSyncEnabled,profilePicUrl:t.profile_pic_url},i=s.values||[],r=Object(b.isUserAdmin)(n),l=!Object(u.getStore)("SyncStatusStore").isSocketConnected,m=e.reduce(s.values,((e,t)=>(e[t.id]={name:t.name,id:t.id,username:t.username,email:t.email,profilePicUrl:t.profilePicUrl},e)),{});return this.state.showPullRequestComments&&l?o.a.createElement("div",{className:e.get(this.props,"contextData.className")||this.props.className},o.a.createElement(g.ContextBarViewHeader,{title:this.props.title,onClose:this.props.onClose}),o.a.createElement(S,{icon:"icon-state-offline-stroke",title:"Check your connection",message:"Get online to view comments"})):o.a.createElement("div",{className:e.get(this.props,"contextData.className")||this.props.className},"pullRequest"===e.get(this.props,"contextData.type")?o.a.createElement(g.ContextBarViewHeader,{title:this.props.title,onClose:this.props.onClose}):o.a.createElement("div",{className:"pull-request-entity-comments__label",onClick:this.toggleEntityComments},o.a.createElement(a.Icon,{name:"icon-action-comments-stroke",color:"content-color-secondary",className:"pull-request-entity-comments__icon"}),this.state.loading?o.a.createElement(y.default,{className:"pull-request-entity-comments__loading"}):o.a.createElement(C.Button,{className:"pull-request-entity-comments__count",size:"small"},Object.keys(this.state.comments||{}).length)),(this.state.showEntityComments||this.state.showPullRequestComments)&&o.a.createElement(p.Comments,f({addCommentPermission:!0},e.pick(this.state,["updating","creating","deleting","loadError","deleteError","updateError"]),{className:e.get(this.props,"contextData.className")||this.props.commentClassName,data:e.sortBy(this.state.comments||[],"createdAt"),isAdmin:r,isOffline:l,loading:this.state.loading,setListRef:this.setListRef,teamUsers:i,teamUsersMap:m,user:n,onClose:this.props.onClose||this.handleHideComments,onCommentCreate:this.handleCreate,onCommentDelete:this.handleDelete,onCommentUpdate:this.handleUpdate,onRetry:this.handleRetry,onUserClick:e=>{Object(h.openTeamUserProfile)(e)},hasError:this.state.hasError})))}})||n)||n}.call(this,s(2753))}}]);