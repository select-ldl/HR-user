(window.webpackJsonp=window.webpackJsonp||[]).push([[31],{"./api-dev/components/api-version/context-bar/api-version-changelog/APIVersionChangelogContextBarView/APIVersionChangelogContextBarViewController.js":function(e,t,o){"use strict";o.r(t),function(e){o.d(t,"default",(function(){return f}));var r,a,i,n,s,l,c=o("./node_modules/@postman/date-helper/index.js"),h=o.n(c),g=o("../../node_modules/mobx/lib/mobx.module.js"),d=o("./schema/services/ChangelogService.js"),p=o("./js/stores/CollectionActivityFeedStore.js"),u=o("./api-dev/util/error.js");function m(){return m=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(e[r]=o[r])}return e},m.apply(this,arguments)}function b(e,t,o,r){o&&Object.defineProperty(e,t,{enumerable:o.enumerable,configurable:o.configurable,writable:o.writable,value:o.initializer?o.initializer.call(r):void 0})}function y(e,t,o,r,a){var i={};return Object.keys(r).forEach((function(e){i[e]=r[e]})),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=o.slice().reverse().reduce((function(o,r){return r(e,t,o)||o}),i),a&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(a):void 0,i.initializer=void 0),void 0===i.initializer&&(Object.defineProperty(e,t,i),i=null),i}let f=(a=y((r=class{constructor(){b(this,"schemaChangelog",a,this),b(this,"collectionChangelogStores",i,this),b(this,"model",n,this),b(this,"isSchemaLoadingMore",s,this),b(this,"isSchemaLoadingMoreError",l,this)}async fetchChangelog(t){try{this.setCollectionChangelogStores([]),this.schemaChangelog=null,this.setIsSchemaLoadingMore(!1),this.setIsSchemaLoadingMoreError(null),this.model=t;let o=[],r=[];const a=this.handleFetchSchemaChangelog(t);r.push(a),this.handleFetchCollectionChangelog(t,r);const i=await Promise.all(r);this.schemaChangelog=e.head(i),o=this.schemaChangelog.data.map((e=>m({},e,{changeType:"schema",enableRestore:!0}))),e.map(this.collectionChangelogStores,(t=>{const r=e.map(e.get(t,"feeds",[]),(o=>m({},o,{changeType:"collection",meta:t.meta,collectionUid:e.get(t,"collectionUid"),enableRestore:!(o.id===e.head(e.get(t,"feeds",[])).id)})));o=e.concat(o,r)})),o=e.chain(o).sortBy("createdAt").reverse().value();const n=await t.getAllReleasesForVersion();return this.groupChangesByRelease(o,n)}catch(e){throw e}}groupChangesByRelease(e,t){let o=t;o.unshift({name:"未发行的更改",id:"unreleasedChanges"});let r=0,a=0;for(;r<e.length;){const t=e[r],i=o[a],n=o[a+1];a===o.length-1||t.createdAt>n.createdAt?(i.changelog?i.changelog.push(t):i.changelog=[t],r++):a++}return o=o.map((e=>m({},e,{changesGroupedByDate:h.a.getDateGroups(e.changelog,"createdAt","MMMM D, YYYY")}))),o}handleFetchSchemaChangelog(t,o=null){const r=e.get(t,"schema.schemaId");return r?Object(d.fetchChangelog)(r,o):Promise.resolve({data:[]})}handleFetchCollectionChangelog(t,o){e.map(this.fetchCollectionIds(t),(async e=>{const t=new p.default;o.push(t.initialize(e)),this.collectionChangelogStores.push(t)}))}fetchCollectionIds(t){const o=new Set;return e.map(["documentations","testSuites","contractTests","integrationTests"],(r=>{e.map(e.get(t,`${r}.relations`,[]),(e=>{o.add(e.modelId)}))})),Array.from(o)}get isLoadingMore(){return!e.every(this.collectionChangelogStores,{isLoadingMore:!1})||this.isSchemaLoadingMore}get isLoaded(){let t=!0;for(let o of this.collectionChangelogStores)t=t&&0===e.get(o,"meta.next_max_id");return t&&!e.get(this.schemaChangelog,"meta.cursor.next")}get loadMoreError(){for(let t of this.collectionChangelogStores)if("loadMore"===e.get(t,"error.type"))return t.error;if(this.isSchemaLoadingMoreError)return m({},this.isSchemaLoadingMoreError,{type:"loadMore"})}setIsSchemaLoadingMore(e){this.isSchemaLoadingMore=e}setIsSchemaLoadingMoreError(e){this.isSchemaLoadingMoreError=e}setCollectionChangelogStores(e){this.collectionChangelogStores=e}async loadMore(){try{if(this.isLoaded||this.isLoadingMore)return;this.setIsSchemaLoadingMore(!0),this.setIsSchemaLoadingMoreError(null);let t=null;try{if(e.get(this.schemaChangelog,"meta.cursor.next")){const t=await this.handleFetchSchemaChangelog(this.model,e.get(this,"schemaChangelog.meta.cursor.next")),o=e.concat(e.get(t,"data",[]),e.get(this.schemaChangelog,"data",[]));this.schemaChangelog=Object.assign({},t,{data:o})}t=this.schemaChangelog.data.map((e=>m({},e,{changeType:"schema",enableRestore:!0})))}catch(e){throw this.setIsSchemaLoadingMoreError(m({},e,{entityType:"schema"})),e}for(const t of this.collectionChangelogStores){if(!e.get(t,"loadMore"))return;try{await t.loadMore()}catch(e){throw e}}e.map(this.collectionChangelogStores,(o=>{const r=e.map(e.get(o,"feeds",[]),(t=>m({},t,{changeType:"collection",meta:o.meta,collectionUid:e.get(o,"collectionUid"),enableRestore:!(t.id===e.head(e.get(o,"feeds",[])).id)})));t=e.concat(t,r)})),t=e.chain(t).sortBy("createdAt").reverse().value();const o=await this.model.getAllReleasesForVersion(),r=this.groupChangesByRelease(t,o);return this.setIsSchemaLoadingMore(!1),r}catch(e){Object(u.default)(e,"加载更多更改时出现意外错误")}}}).prototype,"schemaChangelog",[g.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),i=y(r.prototype,"collectionChangelogStores",[g.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),n=y(r.prototype,"model",[g.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),s=y(r.prototype,"isSchemaLoadingMore",[g.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),l=y(r.prototype,"isSchemaLoadingMoreError",[g.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),y(r.prototype,"isLoadingMore",[g.computed],Object.getOwnPropertyDescriptor(r.prototype,"isLoadingMore"),r.prototype),y(r.prototype,"isLoaded",[g.computed],Object.getOwnPropertyDescriptor(r.prototype,"isLoaded"),r.prototype),y(r.prototype,"loadMoreError",[g.computed],Object.getOwnPropertyDescriptor(r.prototype,"loadMoreError"),r.prototype),y(r.prototype,"setIsSchemaLoadingMore",[g.action],Object.getOwnPropertyDescriptor(r.prototype,"setIsSchemaLoadingMore"),r.prototype),y(r.prototype,"setIsSchemaLoadingMoreError",[g.action],Object.getOwnPropertyDescriptor(r.prototype,"setIsSchemaLoadingMoreError"),r.prototype),y(r.prototype,"setCollectionChangelogStores",[g.action],Object.getOwnPropertyDescriptor(r.prototype,"setCollectionChangelogStores"),r.prototype),r)}.call(this,o("./node_modules/lodash/lodash.js"))}}]);