(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{"./api-dev/components/api-version/context-bar/api-version-changelog/APIVersionChangelogContextBarView/APIVersionChangelogContextBarView.js":function(e,t,a){"use strict";a.r(t),function(e){a.d(t,"default",(function(){return j}));var s,o=a("../../node_modules/react/index.js"),n=a.n(o),i=a("../../node_modules/mobx-react/dist/mobx-react.module.js"),l=a("../../node_modules/mobx/lib/mobx.module.js"),r=a("./node_modules/classnames/index.js"),d=a.n(r),c=a("./appsdk/contextbar/ContextBarViewHeader.js"),h=a("./api-dev/components/api-version/context-bar/api-version-changelog/APIVersionChangelogGroup/APIVersionChangelogGroup.js"),p=a("./js/components/base/LoadingIndicator.js"),g=a("./js/stores/get-store.js"),m=a("../../node_modules/@postman/aether/esmLib/index.js"),u=a("./js/components/base/Buttons.js"),f=a("./schema/components/ErrorChangelog.js"),b=a("./schema/components/OfflineChangelog.js"),D=a("./api-dev/components/release/EditRelease/EditReleaseModal.js"),y=a("./api-dev/components/release/DeleteRelease/DeleteReleaseModal.js"),R=a("./api-dev/util/TooltipText.js"),E=a("./js/components/base/Dropdowns.js"),x=a("./js/services/NavigationService.js"),C=a("./js/modules/services/AnalyticsService.js"),S=a("./js/components/activity-feed/Activity.js"),I=a("./integrations/api-observability/services/Helper.js"),O=a("./integrations/api-observability/constants.js");let j=Object(i.observer)(s=class extends o.Component{constructor(t){super(t),this.state={releaseGroups:[],isLoading:!0,loadingErr:!1,isEditReleaseOpen:!1,releaseName:"",releaseDescription:"",releaseToEdit:null,isDeleteReleaseOpen:!1,releaseToDelete:null,releaseVisibility:!1,configuredIntegration:null,loadingIntegration:!1,APIGatewayDeployText:"Deploy Schema"},this.fetchChangelogs=this.fetchChangelogs.bind(this),this.setEditReleaseModalOpen=this.setEditReleaseModalOpen.bind(this),this.setDeleteReleaseModalOpen=this.setDeleteReleaseModalOpen.bind(this),this.handleScroll=this.handleScroll.bind(this),this.handleScrollDebounced=e.debounce(this.handleScroll,100),this.loadMoreChanges=this.loadMoreChanges.bind(this),this.fetchDeployOptionContext=this.fetchDeployOptionContext.bind(this),this.handleDeploySchemaClick=this.handleDeploySchemaClick.bind(this)}componentDidMount(){this.fetchChangelogs(),this.fetchDeployOptionContext(),this.isReleaseChanging=Object(l.reaction)((()=>e.get(this.props,"contextData.model.isLoadingAddRelease")||e.get(this.props,"contextData.model.isUpdatingRelease")||e.get(this.props,"contextData.model.isUpdatingReleases")),(e=>{e||this.fetchChangelogs()}))}componentWillUnmount(){this.isReleaseChanging&&this.isReleaseChanging()}fetchDeployOptionContext(){if(!I.default.shouldRenderGatewayIntegration(e.get(this.props,"contextData.model")))return!1;let t=e.get(this.props,"contextData.model.id");this.setState({loadingIntegration:!0}),I.default.getDeployOptionContext(t,((t,a)=>{this.setState({loadingIntegration:!1}),t||this.setState({configuredIntegration:e.get(a,"integration",null),APIGatewayDeployText:e.get(a,"deployString","Deploy Schema")})}))}handleDeploySchemaClick(t){const a=e.get(t,"entities.schemas.0.entityId"),s=e.get(t,"entities.schemas.0.tag"),o=e.get(t,"id"),n=e.get(t,"name"),i=e.get(this.props,"contextData.model.id"),l=e.get(this.props,"contextData.model.apiId"),r=e.get(this.state,"configuredIntegration.id");I.default.addDeployClickAnalytics(this.state.configuredIntegration,O.RELEASE_CONTEXTBAR),x.default.transitionTo("build.deployObservability",{apiId:l,versionId:i,integrationId:r},null,{additionalContext:{releaseId:o,schemaId:a,releaseName:n,tagId:s}})}handleScroll(){let t=this.refs.changelog_feed;if(t.scrollHeight-(t.scrollTop+t.offsetHeight)<=5){if(!e.isEmpty(e.get(this.props,"controller.loadMoreError"))||e.get(this.props,"controller.isLoaded")||!e.get(this.props,"controller.loadMore"))return;this.loadMoreChanges()}}loadMoreChanges(){return this.props.controller.loadMore().then((t=>{e.isEmpty(t)||this.setState({releaseGroups:t,isLoading:!1})}))}getRefreshTextClass(){return d()({"api-changelog-context-view-wrapper__refresh-button":!0,"api-changelog-context-view-wrapper__refresh-button__loading":this.state.isLoading})}getRefreshIconText(){return Object(g.getStore)("SyncStatusStore").isSocketConnected?this.state.isLoading?"请稍等...":"刷新更新日志":"联网以执行此操作"}fetchChangelogs(){this.setState({releaseGroups:[],isLoading:!0,loadingErr:!1}),Object(l.when)((()=>!e.get(this.props,"contextData.schemaLoading")),(()=>{this.props.controller.fetchChangelog(e.get(this.props,"contextData.model",{})).then((e=>{this.setState({releaseGroups:e,isLoading:!1})})).catch((e=>{this.setState({isLoading:!1,loadingErr:!0})}))}))}handleReleaseActionSelect(t,a){const s=e.get(t,"id"),o=e.get(t,"name"),n=e.get(t,"description"),i=e.get(t,"visibility");switch(a){case"edit":return C.default.addEventV2({category:"release",action:"initiate_edit",label:"changelog",value:1,entityId:s}),this.setEditReleaseModalOpen(!0,s,o,n,i);case"delete":return C.default.addEventV2({category:"release",action:"initiate_delete",label:"changelog",value:1,entityId:s}),this.setDeleteReleaseModalOpen(!0,s);case"deploy":return this.handleDeploySchemaClick(t)}}handleNameClick(t){const a=e.get(t,"id"),s=e.get(this.props,"contextData.model.id"),o=e.get(this.props,"contextData.model.apiId");"unreleasedChanges"!==a&&(C.default.addEventV2({category:"release",action:"view",label:"changelog",value:1,entityId:a}),e.get(this.props,"contextData.promoteTab")&&e.isFunction(this.props.contextData.promoteTab)&&this.props.contextData.promoteTab(),x.default.transitionTo("build.release",{apiId:o,apiVersionId:s,releaseId:`${a}`}))}renderViewRelease(t){if(!(t=>"unreleasedChanges"===e.get(t,"id"))(t))return n.a.createElement("div",{className:"api-changelog__content__view-release"},n.a.createElement(m.Button,{onClick:this.handleNameClick.bind(this,t),type:"plain",text:"查看此发行"}),n.a.createElement(m.IconDirectionForward,{className:"button-icon"}))}renderReleaseActions(t){const a=!e.get(this.props.contextData.model,"apiPermissionStore.canUpdateRelease"),s=!Object(g.getStore)("SyncStatusStore").isSocketConnected||a,{loadingIntegration:o,configuredIntegration:i,APIGatewayDeployText:l}=this.state;return n.a.createElement("div",null,n.a.createElement(E.Dropdown,{className:"api-changelog__header__release-actions__dropdown",onSelect:this.handleReleaseActionSelect.bind(this,t)},n.a.createElement(E.DropdownButton,{dropdownStyle:"nocaret",type:"custom"},n.a.createElement(m.Button,{type:"tertiary",icon:"icon-action-options-stroke",size:"small",className:"api-changelog__header__release-actions__dropdown__button"})),n.a.createElement(E.DropdownMenu,{"align-right":!0},o?n.a.createElement(E.MenuItem,{disabled:!0,refKey:"deploy"},n.a.createElement(p.default,null)):I.default.shouldRenderDeploy(i)&&I.default.shouldRenderGatewayIntegration(e.get(this.props,"contextData.model"))&&n.a.createElement(E.MenuItem,{refKey:"deploy",disabled:s,disabledText:Object(R.default)(s,!this.canUpdateRelease)},n.a.createElement("span",{title:l},I.default.truncate(l))),n.a.createElement(E.MenuItem,{disabled:s,disabledText:Object(R.default)(s,!this.canUpdateRelease),refKey:"edit"},n.a.createElement("span",null,"编辑")),n.a.createElement(E.MenuItem,{disabled:s,disabledText:Object(R.default)(s,!this.canUpdateRelease),refKey:"delete"},n.a.createElement("span",null,"删除")))))}renderChangelog(){const t=!Object(g.getStore)("SyncStatusStore").isSocketConnected,a=e.get(this.props.contextData.model,"apiPermissionStore.canUpdateRelease");if(t&&this.state.isLoading)return n.a.createElement(b.default,null);if(this.state.isLoading)return n.a.createElement(p.default,null);if(this.state.loadingErr)return n.a.createElement(f.default,{onRetry:this.fetchChangelogs});const s=e.get(this.props,"contextData.model",{}),o=e.get(this.props,"controller.isLoadingMore"),i=e.get(this.props,"controller.loadMoreError",{});return n.a.createElement(n.a.Fragment,null,n.a.createElement("div",{className:"api-changelog",ref:"changelog_feed",onScroll:this.handleScrollDebounced},e.map(this.state.releaseGroups,((t,o)=>n.a.createElement(h.default,{model:s,release:t,promoteTab:e.get(this.props,"contextData.promoteTab"),setEditReleaseModalOpen:this.setEditReleaseModalOpen,setDeleteReleaseModalOpen:this.setDeleteReleaseModalOpen,canUpdateRelease:a,renderActions:this.renderReleaseActions.bind(this,t),renderViewRelease:this.renderViewRelease.bind(this,t),isLastRelease:o===e.get(this.state.releaseGroups,"length")-1,handleRefresh:this.fetchChangelogs})))),(o||!e.isEmpty(i))&&n.a.createElement(S.LoadFeed,{error:i,key:"loading-more",isLoading:o,isOffline:t,onRetry:this.loadMoreChanges}))}setEditReleaseModalOpen(e,t,a,s,o){this.setState({isEditReleaseOpen:e,releaseToEdit:t,releaseName:a,releaseDescription:s,releaseVisibility:o})}setDeleteReleaseModalOpen(e,t){this.setState({isDeleteReleaseOpen:e,releaseToDelete:t})}render(){const t=e.get(this.props,"contextData.model",{});return n.a.createElement("div",{className:"api-changelog-context-view-wrapper"},n.a.createElement(c.ContextBarViewHeader,{title:this.props.title,onClose:this.props.onClose},n.a.createElement(u.Button,{className:this.getRefreshTextClass(),tooltip:this.getRefreshIconText(),tooltipImmediate:!0,type:"tertiary",onClick:this.fetchChangelogs,disabled:this.state.isLoading||!Object(g.getStore)("SyncStatusStore").isSocketConnected},n.a.createElement(m.Icon,{name:"icon-action-refresh-stroke"}))),this.renderChangelog(),n.a.createElement(D.default,{origin:"changelog",isOpen:e.get(this.state,"isEditReleaseOpen"),releaseId:this.state.releaseToEdit,releaseName:this.state.releaseName,releaseVisibility:this.state.releaseVisibility,releaseDescription:this.state.releaseDescription,apiId:t.apiId,apiVersionId:e.get(t,"id"),model:t,toggleUpdateReleaseModal:this.setEditReleaseModalOpen}),n.a.createElement(y.default,{origin:"changelog",isOpen:e.get(this.state,"isDeleteReleaseOpen"),releaseId:this.state.releaseToDelete,apiId:t.apiId,apiVersionId:t.id,deleteReleaseHandler:t.deleteRelease,model:t,isDeletingRelease:e.get(t,"isDeletingRelease"),toggleDeleteReleaseModal:this.setDeleteReleaseModalOpen}))}})||s}.call(this,a("./node_modules/lodash/lodash.js"))}}]);