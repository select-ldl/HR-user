(window.webpackJsonp=window.webpackJsonp||[]).push([[33],{"./api-dev/components/api/api-context-bar/CommentsContextBarView/APICommentsContextBarView.js":function(e,t,o){"use strict";o.r(t),function(e){o.d(t,"default",(function(){return j}));var s,n=o("../../node_modules/react/index.js"),r=o.n(n),a=o("../../node_modules/mobx/lib/mobx.module.js"),i=o("../../node_modules/mobx-react/dist/mobx-react.module.js"),l=o("./js/stores/get-store.js"),m=o("./js/utils/UserHelper.js"),d=o("./collaboration/services/ContextBarCommentService.js"),c=o("./collaboration/components/comments/InlineCommentDrawer.js"),h=o("./node_modules/classnames/index.js"),p=o.n(h),C=o("./js/modules/services/InlineCommentTransformerService.js"),S=o("./appsdk/contextbar/ContextBarViewHeader.js"),u=o("./api-dev/components/common/APIOffline/APIOffline.js"),b=o("./collaboration/services/PermissionService.js"),g=o("./collaboration/constants/comments.js"),f=o("./collaboration/services/CollaborationNavigationService.js"),v=o("./js/services/NavigationService.js");let j=Object(i.observer)(s=class extends n.Component{constructor(e){super(e),this.state={loading:!0,loadError:!1,hasError:!1,isOpenFilterSelected:!0,isResolvedFilterSelected:!1,isScrollable:!0},this.rightOverlayModalRef=null,this.parseError=this.parseError.bind(this),this.handleRetry=this.handleRetry.bind(this),this.setCommentDrawerRef=this.setCommentDrawerRef.bind(this),this.stopScroll=this.stopScroll.bind(this),this.handleClose=this.handleClose.bind(this)}async componentDidMount(){this.setState({loading:!0,loadError:!1}),C.default.handleAnalytics("api","view","api"),d.default.getComments({model:this.props.contextData.commentModel,modelId:this.props.contextData.commentModelId}).then((()=>{requestIdleCallback((()=>{Object(l.getStore)("CommentStore").setLoaded(!0);const t=Object(l.getStore)("CommentStore"),o=t.activeCommentId,s=t.find(o);!o||e.get(s,"anchor","").split("/").length<4?this.setState({loading:!1,loadError:!1}):Object(a.when)((()=>!Object(l.getStore)("APIListStore").isStoreHydrating),(()=>{const t=this.props.contextData.commentModelId,n=Object(l.getStore)("APIListStore").find(t),r=e.get(n,"childEntities.values"),a=e.get(r,"length",0);for(let n=0;n<a;n++){const a=r[n],i=e.get(a,"relationsStore.relations.schema");if(e.head(Object.keys(i))===s.anchor.split("/")[3]){const e={comment:o,ctx:"comments"};v.default.transitionTo("build.apiVersion",{apiId:t,versionId:a.id},e,{tabOptions:{openIn:this.props.editorId}});break}}}))}))})).catch((e=>{this.setState({loading:!1,loadError:!0})}));let t=this.props.contextData.commentModelId,{addComment:o,deleteComment:s,resolveComment:n}=await Object(b.fetchPermissions)(["addComment","deleteComment","resolveComment"],t,g.MODEL_TYPE.API);this.setState({addCommentPermission:o,deleteCommentPermission:s,resolveCommentPermission:n})}componentDidUpdate(){if(!this.state.isResolvedFilterSelected){const t=Object(l.getStore)("CommentStore"),o=t.find(t.activeCommentId),s=Object(l.getStore)("AnnotationStore").find(e.get(o,"annotationId"));e.get(s,"status.resolved")&&this.handleResolvedFilter()}}parseError(e){return e.isFriendly?e.message:""}handleRetry(){return this.setState({loading:!0,loadError:!1}),d.default.getComments({model:this.props.contextData.commentModel,modelId:this.props.contextData.commentModelId}).then((()=>{this.setState({loading:!1,loadError:!1})})).catch((e=>{this.setState({loading:!1,loadError:!0})}))}setCommentDrawerRef(e){this.commentDrawerRef=e,this.commentDrawerRef&&this.forceUpdate()}stopScroll(e){this.setState({isScrollable:!e})}handleClose(){this.props.onClose&&this.props.onClose(),f.default.removeCommentQueryParam()}render(){let t,{commentModel:o,commentModelId:s,schemaId:n}=this.props.contextData||{};t=e.filter(Object(l.getStore)("CommentStore").values,(e=>e.model===o&&e.modelId===s));const a=e.sortBy(e.filter(t,(e=>!e.anchor||e.anchor===`${o}/${s}`)),"createdAt")||[],i=this.props.contextData.model.name,d=Object(l.getStore)("CurrentUserStore")||{},h=Object(l.getStore)("TeamUserStore"),C=e.reduce(h.values,((e,t)=>(e[t.id]={name:t.name,id:t.id,username:t.username,email:t.email,profilePicUrl:t.profilePicUrl,roles:t.roles},e)),{}),b=Object.values(C),g=!Object(l.getStore)("SyncStatusStore").isSocketConnected,f=Object(m.isUserAdmin)(d),v=(e.reduce((t||[]).reverse(),((e,t)=>(e.includes(t.annotationId)||e.push(t.annotationId),e)),[]),Object(l.getStore)("CommentStore")),j=v.find(v.activeCommentId),I=v.setActiveCommentId;let x=e.reduce(t||[],((t,o)=>{let s=o&&o.anchor&&e.get(o.anchor.split("/"),"[3]"),n=(this.props.contextData.versions||[]).filter((t=>s===e.get(t,"schema[0]"))),r=e.get(n,"[0].id");return r&&(t[o.annotationId]={version:r}),t}),{});return g&&this.state.loading?r.a.createElement(r.a.Fragment,null,r.a.createElement(S.ContextBarViewHeader,{onClose:this.props.onClose,title:"评论"}),r.a.createElement(u.default,{origin:"context-bar"})):r.a.createElement("div",{className:p()({"comment-drawer-container":!0,"no-scroll":!this.state.isScrollable}),ref:this.setCommentDrawerRef},r.a.createElement(S.ContextBarViewHeader,{onClose:this.handleClose,title:"评论"}),r.a.createElement("div",{className:"comment-drawer"},r.a.createElement(c.default,{editor:e.get(this.props.contextData,"editor"),comments:t,requestComments:a,isOpenFilterSelected:!0,addCommentPermission:this.state.addCommentPermission,deleteCommentPermission:this.state.deleteCommentPermission,isAdmin:f,isOffline:g,loading:this.state.loading,loadError:this.state.loadError,hasError:this.state.hasError,teamUsers:b,teamUsersMap:C,onRetry:this.handleRetry,user:d,title:i,stopScroll:this.stopScroll,commentRef:this.commentDrawerRef,commentLinkDisabled:e.get(this.props.contextData,"commentLinkDisabled"),model:"api",modelId:e.get(this.props.contextData,"commentModelId"),commentLinkParams:x,origin:"contextBar",anchor:e.get(this.props.contextData,"anchor"),activeComment:j,setActiveComment:I})))}})||s}.call(this,o("./node_modules/lodash/lodash.js"))}}]);